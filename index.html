<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ¨ å¥¢å®  AI è¯•è¡£é—´</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ================= ä¸»é¢˜é…è‰²å®šä¹‰ ================= */
        :root {
            /* èƒŒæ™¯ï¼šæŸ”å’Œçš„ç²‰è‰²æ¸å˜ */
            --bg-gradient-start: #FFF0F5; /* è–°è¡£è‰ç²‰ */
            --bg-gradient-end: #FDE4E8;   /* æµ…ç«ç‘°ç²‰ */
            
            /* æ–‡å­—ä¸å¼ºè°ƒè‰² */
            --text-primary: #6D4C4F;      /* æ·±ç«ç‘°æ£•ï¼Œæ¯”çº¯é»‘æ›´æŸ”å’Œ */
            --text-secondary: #9E8386;
            --accent-gold: #D4AF37;       /* ç«ç‘°é‡‘ç‚¹ç¼€è‰² */
            
            /* æŒ‰é’®ä¸äº¤äº’ */
            --btn-bg: #E69DA5;            /* æŸ”ç²‰è‰²æŒ‰é’® */
            --btn-hover: #D98891;
            --success-color: #4CAF50;

            /* å¡ç‰‡ */
            --card-bg: #FFFFFF;
            --card-shadow: 0 15px 35px rgba(194, 155, 158, 0.15); /* å¸¦ç²‰è‰²è°ƒçš„æŸ”å’Œé˜´å½± */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            /* åº”ç”¨ç²‰è‰²æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
            /* æ·»åŠ å¾®å¦™çš„çº¹ç†æ„Ÿ (å¯é€‰) */
            background-image: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%),
                              url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.2' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='1'/%3E%3Ccircle cx='13' cy='13' r='1'/%3E%3C/g%3E%3C/svg%3E");
        }

        .main-container {
            width: 100%;
            max-width: 460px; /* ç¨å¾®æ”¶çª„ä¸€ç‚¹æ˜¾å¾—æ›´ç²¾è‡´ */
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            z-index: 1;
        }

        header { text-align: center; margin-bottom: 15px; }
        h1 { 
            font-weight: 700; font-size: 28px; letter-spacing: -0.5px; margin-bottom: 8px; 
            /* æ ‡é¢˜ä½¿ç”¨æ¸å˜æ–‡å­—æ•ˆæœ */
            background: linear-gradient(45deg, var(--text-primary), var(--btn-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        p.subtitle { color: var(--text-secondary); font-size: 14px; letter-spacing: 1px; text-transform: uppercase; font-weight: 500; }

        /* å¡ç‰‡é€šç”¨æ ·å¼ - æ›´åœ†æ¶¦æŸ”å’Œ */
        .card {
            background: var(--card-bg);
            border-radius: 28px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(255, 255, 255, 0.6); /* å¢åŠ ä¸€ç‚¹é€šé€æ„Ÿ */
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 20px 40px rgba(194, 155, 158, 0.25); }
        
        .card-header { display: flex; align-items: center; margin-bottom: 20px; }
        .step-number { 
            background: var(--btn-bg); color: white; width: 26px; height: 26px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 600; font-size: 13px; margin-right: 12px;
            box-shadow: 0 4px 10px rgba(230, 157, 165, 0.4);
        }
        h3 { font-weight: 600; font-size: 17px; color: var(--text-primary); }

        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ä¼˜åŒ– */
        .upload-zone {
            position: relative; width: 100%; height: 240px;
            background: #FFF9FA; /* ææµ…çš„ç²‰ç™½ */
            border-radius: 20px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; cursor: pointer;
            border: 2px dashed #F0D0D5;
            transition: all 0.3s;
        }
        .upload-zone:hover { border-color: var(--btn-bg); background: #FFF0F3; }
        .upload-icon { font-size: 36px; color: #E0C0C5; margin-bottom: 12px; transition: color 0.3s; }
        .upload-text { color: var(--text-secondary); font-weight: 500; font-size: 13px; transition: color 0.3s; }
        .upload-zone:hover .upload-icon, .upload-zone:hover .upload-text { color: var(--btn-bg); }
        input[type="file"] { display: none; }
        
        .preview-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; border-radius: 20px; display: none; z-index: 2;
        }
        .has-image .upload-content { opacity: 0; }

        /* æŒ‰é’®æ ·å¼ - ç«ç‘°é‡‘é£æ ¼ */
        .action-area { text-align: center; margin-top: 10px; }
        #try-on-btn {
            width: 100%; padding: 18px;
            background: linear-gradient(45deg, var(--btn-bg), var(--btn-hover)); /* æ¸å˜æŒ‰é’® */
            color: white; border: none; border-radius: 100px;
            font-size: 16px; font-weight: 600; letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(230, 157, 165, 0.4);
            transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #try-on-btn:hover { transform: scale(1.02) translateY(-2px); box-shadow: 0 15px 30px rgba(230, 157, 165, 0.5); }
        #try-on-btn:disabled { background: #CCC; cursor: not-allowed; transform: none; box-shadow: none; }

        /* åŠ è½½çŠ¶æ€ä¼˜åŒ– */
        .status-container {
            min-height: 30px; display: flex; align-items: center; justify-content: center; 
            gap: 10px; margin-top: 15px; color: var(--text-secondary); font-size: 13px; font-weight: 500;
        }
        .spinner {
            width: 16px; height: 16px; border: 2px solid rgba(230, 157, 165, 0.2);
            border-top: 2px solid var(--btn-bg); border-radius: 50%;
            animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .generating .spinner { display: block; }

        /* ================= æ ¸å¿ƒåŠ¨ç”»åŒºåŸŸï¼šç»“æœå±•ç¤º ================= */
        #result-area { 
            display: none; 
            /* ä½¿ç”¨æ›´ä¸æ»‘çš„è´å¡å°”æ›²çº¿ */
            animation: premiumReveal 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; 
        }

        /* å®šä¹‰é«˜çº§æ­å¹•åŠ¨ç”»ï¼šä¸Šæµ® + ç¼©æ”¾ + é€æ˜åº¦ */
        @keyframes premiumReveal {
            0% { opacity: 0; transform: translateY(40px) scale(0.96); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .success-tag { 
            display: inline-flex; align-items: center; gap: 6px; background: #E8F5E9; color: var(--success-color); 
            padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
        }

        /* å›¾ç‰‡å®¹å™¨ï¼šç”¨äºåŒ…è£¹æµå…‰åŠ¨ç”» */
        .image-wrapper {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(194, 155, 158, 0.3); /* æ›´æ·±é‚ƒçš„ç²‰è‰²é˜´å½± */
        }
        
        #result-image { width: 100%; display: block; }

        /* æ·»åŠ æµå…‰æ‰«è¿‡æ•ˆæœ (Shimmer Effect) */
        .image-wrapper::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            /* åŠé€æ˜çš„ç™½è‰²å…‰æŸ */
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.5) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: skewX(-25deg);
            /* åŠ¨ç”»æŒç»­æ—¶é—´ä¸ reveal åŠ¨ç”»åŒ¹é…ï¼Œå»¶è¿Ÿä¸€ç‚¹æ’­æ”¾ */
            animation: shimmer 1.5s ease-in-out 0.3s forwards;
        }
        @keyframes shimmer {
            100% { left: 150%; }
        }

    </style>
</head>
<body>

    <div class="main-container">
        <header>
            <h1>èŠ±èŠ±è¯•è¡£é—´</h1>
            <p class="subtitle">æ‚¨çš„ç§äººè¯•è¡£é—´</p>
        </header>

        <div class="card">
            <div class="card-header">
                <span class="step-number">1</span>
                <h3>é€‰æ‹©æ‚¨çš„ä¸»è§’ (å…¨èº«ç…§)</h3>
            </div>
            <label for="person-upload" class="upload-zone" id="person-zone">
                <div class="upload-content">
                    <div class="upload-icon" style="font-size: 32px;">ğŸ‘¸</div>
                    <span class="upload-text">ç‚¹å‡»ä¸Šä¼ äººç‰©åº•å›¾</span>
                </div>
                <input type="file" id="person-upload" accept="image/*">
                <img id="person-preview" class="preview-img">
            </label>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="step-number">2</span>
                <h3>é€‰æ‹©å¿ƒä»ªç©¿æ­ (æœè£…ç…§)</h3>
            </div>
            <label for="clothes-upload" class="upload-zone" id="clothes-zone">
                <div class="upload-content">
                    <div class="upload-icon" style="font-size: 32px;">ğŸ‘—</div>
                    <span class="upload-text">ç‚¹å‡»ä¸Šä¼ æœè£…å¹³é“º/æ¨¡ç‰¹å›¾</span>
                </div>
                <input type="file" id="clothes-upload" accept="image/*">
                <img id="clothes-preview" class="preview-img">
            </label>
        </div>

        <div class="action-area">
            <button id="try-on-btn">âœ¨ å¼€å¯é«˜å®šè¯•ç©¿ä¹‹æ—…</button>
            <div class="status-container" id="status-box">
                <div class="spinner"></div>
                <span id="status-text"></span>
            </div>
        </div>

        <div id="result-area" class="card" style="border: 1px solid var(--btn-bg);">
             <div class="result-header">
                 <h3>ğŸŒŸ æ‚¨çš„ä¸“å±è¯•ç©¿æ•ˆæœ</h3>
                 <div class="success-tag">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    å®Œç¾å‘ˆç°
                </div>
             </div>
            
            <div class="image-wrapper">
                <img id="result-image" alt="è¯•ç©¿ç»“æœ">
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        // âš ï¸ è¯·ç¡®ä¿è¿™é‡Œæ˜¯ä½ çš„é˜¿é‡Œäº‘å…¬ç½‘ IPï¼Œå¹¶ä¸”åç«¯æ˜¯å¼‚æ­¥ç‰ˆæœ¬
        const API_BASE = "http://39.108.123.216:3000";
        // =========================================
        
        const personInput = document.getElementById('person-upload');
        const clothesInput = document.getElementById('clothes-upload');
        const tryOnBtn = document.getElementById('try-on-btn');
        const statusText = document.getElementById('status-text');
        const statusBox = document.getElementById('status-box');
        const resultArea = document.getElementById('result-area');
        const resultImage = document.getElementById('result-image');

        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        function setupPreview(input, imgId, zoneId) {
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const img = document.getElementById(imgId);
                    const zone = document.getElementById(zoneId);
                    img.src = URL.createObjectURL(file);
                    img.style.display = 'block';
                    zone.classList.add('has-image');
                }
            });
        }
        setupPreview(personInput, 'person-preview', 'person-zone');
        setupPreview(clothesInput, 'clothes-preview', 'clothes-zone');

        let pollInterval;
        async function pollStatus(taskId) {
            statusBox.classList.add('generating');
            // ä½¿ç”¨æ›´å¯Œæœ‰æƒ…æ„Ÿçš„æç¤ºè¯­
            const loadingTexts = [
                'AI é€ å‹å¸ˆæ­£åœ¨ä¸ºæ‚¨é‡èº«å®šåˆ¶...',
                'æ­£åœ¨ç²¾ç»†è°ƒæ•´æœè£…è¤¶çš±ä¸å…‰å½±...',
                'å³å°†å®Œæˆï¼Œè¯·æœŸå¾…æƒŠè‰³ä¸€åˆ»...',
            ];
            let textIndex = 0;
            statusText.textContent = loadingTexts[0];
            const textInterval = setInterval(() => {
                textIndex = (textIndex + 1) % loadingTexts.length;
                statusText.textContent = loadingTexts[textIndex];
            }, 8000); // æ¯8ç§’åˆ‡æ¢ä¸€æ¬¡æç¤ºè¯­
            
            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/check-task/${taskId}`);
                    const data = await res.json();

                    if (data.success) {
                        if (data.status === 'succeed') {
                            clearInterval(pollInterval);
                            clearInterval(textInterval);
                            showResult(data.image);
                        } else if (data.status === 'failed') {
                            clearInterval(pollInterval);
                            clearInterval(textInterval);
                            showError(data.fail_reason);
                        }
                    }
                } catch (err) {
                   console.warn("ç½‘ç»œæ³¢åŠ¨ï¼Œé‡è¯•ä¸­...");
                }
            }, 3000);
        }

        function showResult(imageUrl) {
            statusBox.classList.remove('generating');
            statusText.textContent = '';
            
            // é¢„åŠ è½½å›¾ç‰‡ï¼Œç¡®ä¿åŠ¨ç”»æµç•…
            const img = new Image();
            img.onload = () => {
                resultImage.src = imageUrl;
                // æ˜¾ç¤ºåŒºåŸŸï¼Œè§¦å‘ CSS åŠ¨ç”»
                resultArea.style.display = 'block';
                // å¹³æ»‘æ»šåŠ¨åˆ°ç»“æœåŒº
                setTimeout(() => {
                     resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                resetBtn('âœ¨ é‡æ–°å®šåˆ¶');
            };
            img.src = imageUrl;
        }

        function showError(msg) {
            statusBox.classList.remove('generating');
            statusText.textContent = 'âŒ å®šåˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•';
            alert('æŠ±æ­‰ï¼Œæœ¬æ¬¡å®šåˆ¶æœªæˆåŠŸï¼š' + msg);
            resetBtn('é‡è¯•');
        }

        function resetBtn(text) {
            tryOnBtn.disabled = false;
            tryOnBtn.innerHTML = text;
            // æ¢å¤æ¸å˜èƒŒæ™¯
            tryOnBtn.style.background = 'linear-gradient(45deg, var(--btn-bg), var(--btn-hover))';
        }

        tryOnBtn.addEventListener('click', async () => {
            if (!personInput.files[0] || !clothesInput.files[0]) {
                alert('è¯·å…ˆä¸Šä¼ äººç‰©å’Œæœè£…ä¸¤å¼ ç…§ç‰‡');
                return;
            }

            tryOnBtn.disabled = true;
            tryOnBtn.innerHTML = 'ğŸš€ ç´ æä¸Šä¼ ä¸­...';
            tryOnBtn.style.background = '#CCC'; // ç¦ç”¨æ—¶çš„ç°è‰²
            statusText.textContent = '';
            resultArea.style.display = 'none'; // éšè—ä¹‹å‰çš„åŠ¨ç”»ç»“æœ
            if (pollInterval) clearInterval(pollInterval);

            try {
                const humanBase64 = await fileToBase64(personInput.files[0]);
                const garmBase64 = await fileToBase64(clothesInput.files[0]);

                tryOnBtn.innerHTML = 'â³ AI åŠªåŠ›ç»˜åˆ¶ä¸­å¤§äºéœ€è¦1~2åˆ†é’Ÿ...';
                const res = await fetch(`${API_BASE}/api/submit-task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ human_img: humanBase64, garm_img: garmBase64 })
                });
                const data = await res.json();

                if (data.success && data.taskId) {
                    pollStatus(data.taskId);
                } else {
                    throw new Error(data.error || "ä»»åŠ¡æäº¤å¤±è´¥");
                }

            } catch (error) {
                console.error(error);
                showError('æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }
        });
    </script>
</body>
</html>
